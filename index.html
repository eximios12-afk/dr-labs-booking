<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>DRLabs Booking</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 600px; margin: auto; }
    label { display: block; margin-top: 10px; }
    input, select { width: 100%; padding: 8px; margin-top: 5px; }
    button { margin-top: 15px; padding: 10px 15px; background-color: #2a8bf2; color: white; border: none; cursor: pointer; }
    button:hover { background-color: #1b6fcc; }
    .message { margin-top: 15px; font-weight: bold; }
  </style>
</head>
<body>
  <h1>DRLabs Booking</h1>

  <form id="bookingForm">
    <label>Patient Name
      <input type="text" id="patientName" required />
    </label>

    <label>Mobile Number
      <input type="tel" id="mobile" pattern="[0-9]{10}" placeholder="10-digit number" required />
    </label>

    <label>Address
      <input type="text" id="address" required />
    </label>

    <label>Date
      <input type="date" id="date" required />
    </label>

    <label>Time
      <input type="time" id="time" required />
    </label>

    <label>Select Tests
      <select id="tests" multiple required></select>
      <small>Hold Ctrl (Windows) or Cmd (Mac) to select multiple</small>
    </label>

    <label>Select Phlebotomist
      <select id="phlebotomists" required></select>
    </label>

    <label>Agent Username
      <input type="text" id="agent" value="agent01" required />
    </label>

    <button type="submit">Book Now</button>
  </form>

  <div class="message" id="messageArea"></div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxGrN4TJFFq6XdRGXbYHRV8U7xHaWSobg9-lyQ2uhUlH7AUj_5nJkQIlFWV3R2IcXqw4w/exec';

    // Load Tests & Phlebotomists from Google Sheets via Apps Script API
    async function loadTests() {
      const resp = await fetch(SCRIPT_URL + '?action=getTests');
      const data = await resp.json();
      // data[0] is headers, so skip it
      const testsSelect = document.getElementById('tests');
      for(let i = 1; i < data.length; i++) {
        if (data[i][1].toLowerCase() === 'yes') {
          const option = document.createElement('option');
          option.value = data[i];  // Test ID
          option.textContent = `${data[i][2]} (â‚¹${data[i][3]})`;
          testsSelect.appendChild(option);
        }
      }
    }

    async function loadPhlebotomists() {
      const resp = await fetch(SCRIPT_URL + '?action=getPhlebotomists');
      const data = await resp.json();
      const phlebSelect = document.getElementById('phlebotomists');
      for (let i = 1; i < data.length; i++) {
        const option = document.createElement('option');
        option.value = data[i]; // Phlebotomist ID
        option.textContent = data[i][2];
        phlebSelect.appendChild(option);
      }
    }

    // Form submission handler
    document.getElementById('bookingForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const patientName = document.getElementById('patientName').value.trim();
      const mobile = document.getElementById('mobile').value.trim();
      const address = document.getElementById('address').value.trim();
      const date = document.getElementById('date').value;
      const time = document.getElementById('time').value;
      const testsSelect = document.getElementById('tests');
      const agent = document.getElementById('agent').value.trim();
      const phlebotomist = document.getElementById('phlebotomists').value;

      // Collect selected test IDs into comma-separated string
      const selectedTests = Array.from(testsSelect.selectedOptions).map(opt => opt.value).join(',');

      if (!patientName || !mobile || !address || !date || !time || !selectedTests || !phlebotomist || !agent) {
        showMessage("Please fill in all fields", "red");
        return;
      }

      // Prepare data payload
      const payload = {
        patientName: patientName,
        mobile: mobile,
        address: address,
        date: date,
        time: time,
        testIds: selectedTests,
        phlebId: phlebotomist,
        agent: agent
      };

      try {
        const response = await fetch(SCRIPT_URL + '?action=addBooking', {
          method: 'POST',
          body: JSON.stringify(payload),
          headers: { 'Content-Type': 'application/json' }
        });
        const text = await response.text();

        if (text === "Success") {
          showMessage("Booking Successfully Created!", "green");
          document.getElementById('bookingForm').reset();
        } else {
          showMessage(text, "red");
        }
      } catch (error) {
        showMessage("Error submitting booking: " + error.message, "red");
      }
    });

    // Helper to show messages
    function showMessage(msg, color) {
      const msgArea = document.getElementById('messageArea');
      msgArea.textContent = msg;
      msgArea.style.color = color;
    }

    // Load data when page loads
    window.onload = async function () {
      await loadTests();
      await loadPhlebotomists();
    };
  </script>
</body>
</html>
